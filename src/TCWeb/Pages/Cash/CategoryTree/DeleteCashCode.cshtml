@page
@model TradeControl.Web.Pages.Cash.CategoryTree.DeleteCashCodeModel
@{
    var isEmbedded = string.Equals(Request.Query["embed"], "1", StringComparison.Ordinal);
    if (isEmbedded)
    {
        Layout = null;
    }

    var deletedNodeKey = string.IsNullOrWhiteSpace(Model.CashCode)
        ? ""
        : (Model.CashCode.StartsWith("code:", StringComparison.OrdinalIgnoreCase)
            ? Model.CashCode
            : $"code:{Model.CashCode}");
}

@if (Model.OperationSucceeded && isEmbedded)
{
    <div id="tcEmbedResult"
         data-select="@Model.ParentCategoryCode"
         data-expand="@Model.ParentCategoryCode"
         data-remove="@deletedNodeKey"></div>
}
else if (!Model.OperationSucceeded)
{
    <h6 class="mb-2">Delete Cash Code</h6>

    <div class="alert alert-warning" role="alert">
        <strong>Warning:</strong> Deleting a Cash Code will be refused if related payments or transactions exist.
        Remove or reassign related payment/transaction rows before attempting to delete.
    </div>

    <form method="post"
          asp-page="./DeleteCashCode"
          asp-route-key="@(string.IsNullOrWhiteSpace(Model.Key) ? deletedNodeKey : Model.Key)"
          asp-route-embed="@(isEmbedded ? "1" : null)">
        @Html.AntiForgeryToken()
        @if (isEmbedded)
        {
            <input type="hidden" name="embed" value="1" />
        }
        <input type="hidden" name="CashCode" value="@Model.CashCode" />
        <input type="hidden" name="Key" value="@deletedNodeKey" />
        <input type="hidden" name="ParentCategoryCode" value="@Model.ParentCategoryCode" />

        <p class="small mb-3">@Model.CodeDisplay</p>
        <div class="d-flex gap-2">
            <button type="submit" class="btn btn-danger btn-sm">Delete</button>
            @if (isEmbedded)
            {
                <a class="btn btn-secondary btn-sm" href="#" data-embedded-cancel
                   onclick="try{ if(window.tcCancel){ window.tcCancel(); } }catch(e){} return false;">Cancel</a>
            }
            else
            {
                <!-- Mobile/full-page Cancel: return with parent category selected -->
                <a class="btn btn-secondary btn-sm"
                   href="/Cash/CategoryTree/Index?select=@Model.ParentCategoryCode&key=@Model.ParentCategoryCode&expand=@Model.ParentCategoryCode&parentKey=@Model.ParentCategoryCode">
                    Cancel
                </a>
            }
        </div>
    </form>
}
else
{
    <div class="text-muted small py-1 px-2">Cash code removed.</div>
}
