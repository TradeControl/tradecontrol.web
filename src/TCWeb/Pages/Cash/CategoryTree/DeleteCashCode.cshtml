@page
@model TradeControl.Web.Pages.Cash.CategoryTree.DeleteCashCodeModel
@{
    var isEmbedded = (Request.Query["embed"] == "1") || (Request.HasFormContentType && Request.Form["embed"] == "1");
    Layout = isEmbedded ? null : "_Layout";
}

@if (Model.OperationSucceeded && isEmbedded)
{
    <div id="deleteCashCodeResult"
         data-cashcode="@Model.CashCode"
         data-parent="@Model.ParentCategoryCode"></div>

    <div class="alert alert-success small mb-2">Cash code deleted.</div>

    <script>
        (function () {
            try {
                var m = document.getElementById("deleteCashCodeResult");
                if (!m) return;
                var raw = m.getAttribute("data-cashcode") || "";
                var parent = m.getAttribute("data-parent") || "";
                if (!raw) return;
                // Remove node and select parent (no duplicate code)
                var tree = $.ui && $.ui.fancytree && $.ui.fancytree.getTree("#categoryTree");
                if (!tree) return;
                var node = tree.getNodeByKey("code:" + raw);
                var parentNode = node && node.getParent ? node.getParent() : (parent ? tree.getNodeByKey(parent) : null);
                if (node) { try { node.remove(); } catch(e){} }
                if (parentNode) {
                    try { parentNode.makeVisible(); } catch(e){}
                    try { parentNode.setActive(true); } catch(e){}
                    if (typeof window.loadDetails === "function") { window.loadDetails(parentNode); }
                }
            } catch(_) {}
        })();
    </script>
}
else
{
    <div class="card">
        <div class="card-body">
            <h5 class="card-title">Delete Cash Code</h5>

            @if (string.IsNullOrWhiteSpace(Model.CashCode))
            {
                <div class="alert alert-warning small">Missing key. No deletion performed.</div>
            }
            else
            {
                <!-- Original warning retained -->
                <div class="alert alert-warning" role="alert">
                    <strong>Warning:</strong> Deleting a Cash Code will be refused if related payments or transactions exist.
                    Remove or reassign related payment/transaction rows before attempting to delete.
                </div>

                <form method="post"
                      asp-page="./DeleteCashCode"
                      asp-route-key="@(string.IsNullOrWhiteSpace(Model.Key) ? $"code:{Model.CashCode}" : Model.Key)"
                      asp-route-embed="@(isEmbedded ? "1" : null)">
                    @Html.AntiForgeryToken()
                    @if (isEmbedded)
                    {
                        <input type="hidden" name="embed" value="1" />
                    }
                    <input type="hidden" name="CashCode" value="@Model.CashCode" />
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-danger">Delete</button>
                        <a class="btn btn-secondary" href="#" data-embedded-cancel
                           onclick="try{ if(window.tcCancel){ window.tcCancel(); } }catch(e){} return false;">Cancel</a>
                    </div>
                </form>
            }
        </div>
    </div>

    <script src="~/js/categoryTree.cancel.js" asp-append-version="true"></script>
    <script>
        // Ensure embedded desktop submits POST (fallback if global binder not present)
        (function(){
            try {
                if (!@((isEmbedded).ToString().ToLower())) return;
                var f = document.getElementById("deleteCashCodeForm");
                if (!f) return;
                if (window.tcTree && typeof window.tcTree.bindEmbeddedFormSubmit === "function") {
                    window.tcTree.bindEmbeddedFormSubmit();
                    return;
                }
                // Fallback: AJAX POST and replace pane
                f.addEventListener("submit", function(ev){
                    ev.preventDefault();
                    var fd = new FormData(f);
                    fetch(window.location.href, {
                        method: "POST",
                        headers: {
                            "X-Requested-With": "XMLHttpRequest"
                        },
                        body: fd
                    })
                    .then(r => r.text())
                    .then(html => {
                        var pane = document.getElementById("detailsPane");
                        if (pane) { pane.innerHTML = html; }
                    })
                    .catch(()=> alert("Delete failed (network error)"));
                });
            } catch(_) {}
        })();
    </script>
}
