@page
@model TradeControl.Web.Pages.Cash.CategoryTree.MoveModel
@{
    bool embed = false;

    if (Request?.Query.ContainsKey("embed") == true)
    {
        embed = Request.Query["embed"].ToString() == "1";
    }

    Layout = embed ? null : "_Layout";
    ViewData["Title"] = "Move Category";
}

<div class="card shadow-sm">
    <div class="card-header">
        <strong>Move Category</strong>
    </div>
    <div class="card-body">
        <div class="mb-3">
            <div class="fw-semibold">Category</div>
            <div>@Model.CategoryName (@Model.CategoryCode)</div>
        </div>

        @if (Model.OperationSucceeded)
        {
            <div id="moveResult"
                 data-old="@Model.OldParentKey"
                 data-parent="@Model.NewParentKey"
                 data-key="@Model.CategoryCode"
                 data-path="@Model.NewParentPath"></div>

            <div class="alert alert-success py-2">Category moved.</div>
            <script>
                (function ()
                {
                    try
                    {
                        var embedded = @(embed ? "true" : "false");
                        if (!embedded)
                        {
                            window.location.href = "@Url.Page("./Index")";
                        }
                    }
                    catch { }
                })();
            </script>
        }

        <form id="moveForm" method="post" asp-page="./Move" asp-route-embed="@(embed ? "1" : null)" novalidate>
            @Html.AntiForgeryToken()
            <input type="hidden" asp-for="Key" />
            <input type="hidden" asp-for="ParentKey" />

            <div class="mb-3">
                <label for="TargetParentKey" class="form-label">New Parent</label>
                <select asp-for="TargetParentKey" asp-items="Model.CandidateParents" class="form-select">
                    <option value="">-- Select parent --</option>
                </select>
                <div class="form-text">
                    Candidates are filtered to the same Cash Type; polarity must match unless the target or the source is Neutral. Descendants are excluded.
                </div>
            </div>

            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-arrow-right"></i> Move
                </button>

                @if (embed)
                {
                    <button type="button" id="btnCancel" class="btn btn-outline-secondary">Cancel</button>
                }
                else
                {
                    <a href="@Url.Page("./Index")" class="btn btn-outline-secondary">Cancel</a>
                }
            </div>
        </form>
    </div>
</div>
