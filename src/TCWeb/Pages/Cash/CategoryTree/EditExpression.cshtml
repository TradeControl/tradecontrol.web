@page
@model TradeControl.Web.Pages.Cash.CategoryTree.EditExpressionModel
@{
    var embed = (Request.Query["embed"] == "1") || (Request.HasFormContentType && Request.Form["embed"] == "1");
    if (embed) { Layout = null; }

    var exprKey = TradeControl.Web.Pages.Cash.CategoryTree.CategoryTreeModel.MakeExpressionKey(Model.CategoryCode);

    var syntaxValue = Model.SyntaxTypeCode ?? (short)TradeControl.Web.Data.NodeEnum.SyntaxType.Both;
    bool isBothOrLibre = syntaxValue == (short)TradeControl.Web.Data.NodeEnum.SyntaxType.Both
                         || syntaxValue == (short)TradeControl.Web.Data.NodeEnum.SyntaxType.LibreOffice;
    bool isExcel = syntaxValue == (short)TradeControl.Web.Data.NodeEnum.SyntaxType.Excel;
}

<div class="container-fluid p-2">
    <h5 class="mb-3"><span class="bi bi-calculator me-1"></span>Edit Cash Expression</h5>

    @if (Model.SaveSucceeded && !embed)
    {
        <div class="alert alert-success py-2 small mb-3">Expression saved.</div>
    }

    <form method="post"
          asp-page="./EditExpression"
          asp-route-key="@exprKey"
          asp-route-embed="@(embed ? "1" : null)">
        @Html.AntiForgeryToken()

        @if (embed)
        {
            <input type="hidden" name="embed" value="1" />
        }

        <input type="hidden" name="key" value="@exprKey" />
        <input type="hidden" asp-for="CategoryCode" />

        <div class="mb-3">
            <label asp-for="Category" class="form-label"></label>
            <input asp-for="Category" class="form-control" maxlength="50" />
            <span asp-validation-for="Category" class="text-danger small"></span>
        </div>

        <div class="mb-3">
            <label asp-for="CashTypeCode" class="form-label"></label>
            <select asp-for="CashTypeCode" asp-items="Model.CashTypeItems" class="form-select"></select>
            <span asp-validation-for="CashTypeCode" class="text-danger small"></span>
        </div>

        <div class="mb-3">
            <label asp-for="Expression" class="form-label"></label>
            <textarea asp-for="Expression" class="form-control" rows="3" maxlength="256"></textarea>
            <span asp-validation-for="Expression" class="text-danger small"></span>
            <div class="form-text small">
                Spreadsheet formula (for example IF([Sales]=0,0,[Gross Profit]/[Sales])).
                Use category codes in square brackets.
            </div>
        </div>

        <div class="mb-3">
            <label asp-for="SyntaxTypeCode" class="form-label"></label>
            <select asp-for="SyntaxTypeCode"
                    asp-items="Model.SyntaxTypeItems"
                    class="form-select"
                    id="syntaxType">
            </select>
            <span asp-validation-for="SyntaxTypeCode" class="text-danger small"></span>
            <div class="form-text small">
                Choose the target expression engine: Both, LibreOffice, or Excel.
            </div>
        </div>

        <!-- Format via TemplateCode (Both / LibreOffice) -->
        <div class="mb-3" data-role="format-template" style="display:@(isBothOrLibre ? "block" : "none")">
            <label asp-for="Format" class="form-label"></label>
            <select asp-for="Format" class="form-select" id="formatTemplate">
                <option value="">-- select format template --</option>
                @foreach (var item in Model.FormatTemplateItems)
                {
                    var selected = string.Equals(item.Value, Model.Format, StringComparison.OrdinalIgnoreCase);
                    <option value="@item.Value" selected="@(selected ? "selected" : null)">
                        @item.Text
                    </option>
                }
            </select>
            <span asp-validation-for="Format" class="text-danger small"></span>
            <div class="form-text small">
                For Both or LibreOffice, select a format template.
                The underlying template code is stored in the Format field and must exist in Cash.tbCategoryExprFormat.
            </div>
        </div>

        <!-- Format as free text (Excel) -->
        <div class="mb-3" data-role="format-freetext" style="display:@(isExcel ? "block" : "none")">
            <label asp-for="Format" class="form-label"></label>
            <input asp-for="Format" class="form-control" list="formatList" maxlength="100" id="formatFreeText" />
            <datalist id="formatList">
                @foreach (var f in Model.ExistingFormats)
                {
                    if (!string.IsNullOrWhiteSpace(f))
                    {
                        <option value="@f">@f</option>
                    }
                }
            </datalist>
            <span asp-validation-for="Format" class="text-danger small"></span>
            <div class="form-text small">
                For Excel, enter any spreadsheet format string (for example 0.00, 0%, #,##0.00).
                Excel validates the format when the expression is rendered.
            </div>
        </div>

        @if (Model.IsError && !string.IsNullOrWhiteSpace(Model.ErrorMessage))
        {
            <div class="alert alert-warning small py-1">
                <strong>Evaluation error:</strong> @Model.ErrorMessage
            </div>
        }

        <div class="d-flex gap-2">
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-save"></i> Save
            </button>

            @if (embed)
            {
                <button type="button" class="btn btn-secondary" data-embedded-cancel>
                    <i class="bi bi-x-circle"></i> Cancel
                </button>
            }
            else
            {
                <a asp-page="/Cash/CategoryTree/Index"
                   asp-route-select="@exprKey"
                   asp-route-expand="@TradeControl.Web.Pages.Cash.CategoryTree.CategoryTreeModel.ExpressionsNodeKey"
                   class="btn btn-secondary">
                    <i class="bi bi-x-circle"></i> Cancel
                </a>
            }
        </div>
    </form>
</div>

<script>
    (function () {
        var templateMap = @Html.Raw((string)(ViewData["FormatTemplateMap"] ?? "{}"));

        function updateFormatEditors(selectElement) {
            var syntaxSelect = selectElement || document.getElementById('syntaxType');
            if (!syntaxSelect) return;

            var value = syntaxSelect.value;
            var isBothOrLibre = (value === '0' || value === '1');
            var isExcel = (value === '2');

            var templateDiv = document.querySelector('[data-role="format-template"]');
            var freeTextDiv = document.querySelector('[data-role="format-freetext"]');
            var templateSelect = document.getElementById('formatTemplate');
            var freeTextInput = document.getElementById('formatFreeText');

            if (templateDiv && freeTextDiv && templateSelect && freeTextInput) {
                var currentlyTemplateVisible = templateDiv.style.display !== 'none';

                // When switching from template mode to Excel, copy the template format into free text
                if (currentlyTemplateVisible && isExcel) {
                    var code = templateSelect.value;
                    if (code && templateMap && templateMap[code]) {
                        freeTextInput.value = templateMap[code];
                    } else if (code) {
                        freeTextInput.value = code;
                    }
                }

                // Only one Format input should participate in model binding
                if (isBothOrLibre) {
                    templateSelect.disabled = false;
                    freeTextInput.disabled = true;
                } else if (isExcel) {
                    templateSelect.disabled = true;
                    freeTextInput.disabled = false;
                } else {
                    // Fallback: both enabled
                    templateSelect.disabled = false;
                    freeTextInput.disabled = false;
                }
            }

            if (templateDiv) {
                templateDiv.style.display = isBothOrLibre ? 'block' : 'none';
            }

            if (freeTextDiv) {
                freeTextDiv.style.display = isExcel ? 'block' : 'none';
            }
        }

        var syntaxSelect = document.getElementById('syntaxType');
        if (syntaxSelect) {
            syntaxSelect.addEventListener('change', function () {
                updateFormatEditors(this);
            });

            updateFormatEditors(syntaxSelect);
        }
    })();
</script>
