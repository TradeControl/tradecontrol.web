@page
@model TradeControl.Web.Pages.Cash.CategoryTree.CreateCategoryModel
@inject Microsoft.AspNetCore.Antiforgery.IAntiforgery Antiforgery
@{
    Layout = null;
    var isEmbedded = (Request.Query["embed"] == "1") || (Request.HasFormContentType && Request.Form["embed"] == "1");
}

@if (Model.OperationSucceeded && isEmbedded)
{
    <div id="createCategoryResult"
         data-key="@Model.NewKey"
         data-parent="@Model.NewParentKey"
         data-name="@Model.Category"
         data-polarity="@Model.CashPolarityCode"
         data-categorytype="@( (short)TradeControl.Web.Data.NodeEnum.CategoryType.CashCode )"
         data-isenabled="@(Model.IsEnabled ? 1 : 0)"></div>
}
else
{
    <div class="card">
        <div class="card-body">
            <h5 class="card-title">Create Category</h5>

            <form method="post" asp-page="./CreateCategory" asp-route-parentKey="@Model.ParentKey" asp-route-embed="1">
                @Html.AntiForgeryToken()
                <input asp-for="ParentKey" type="hidden" />
                <div class="mb-3">
                    <label asp-for="CategoryCode" class="form-label">Category Code</label>
                    <input asp-for="CategoryCode" class="form-control" maxlength="10" />
                </div>

                <div class="mb-3">
                    <label asp-for="Category" class="form-label">Category Name</label>
                    <input asp-for="Category" class="form-control" maxlength="50" />
                </div>

                <div class="mb-3">
                    <label asp-for="CashTypeCode" class="form-label">Cash Type</label>
                    <select asp-for="CashTypeCode" class="form-select" asp-items="Model.CashTypes"></select>
                </div>

                <div class="mb-3">
                    <label asp-for="CashPolarityCode" class="form-label">Polarity</label>
                    <select asp-for="CashPolarityCode" class="form-select" asp-items="Model.Polarities"></select>
                </div>

                <div class="form-check mb-3">
                    <input asp-for="IsEnabled" class="form-check-input" type="checkbox" />
                    <label asp-for="IsEnabled" class="form-check-label">Enabled</label>
                </div>

                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary">Create</button>

                    @* Cancel: fetch parent details and select the parent node (same pattern as CreateCode.cshtml) *@
                    <a class="btn btn-secondary" href="javascript:void(0)" onclick="tcCancel()">Cancel</a>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Cancel helper: reloads the parent details into #detailsPane.
        // - No debug alert.
        // - If not embedded or details pane missing, navigate back to index.
        // - If parent is empty or a disconnected token, show "No details".
        function tcCancel()
        {
            try
            {
                var p = document.getElementById('detailsPane');
                var parentInput = document.querySelector('input[name="ParentKey"]');
                var parent = parentInput ? (parentInput.value || '') : '';

                // Not embedded -> navigate to index
                if (!p)
                {
                    window.location.href = '@Url.Page("/Cash/CategoryTree/Index")';
                    return;
                }

                // Treat empty parent or common disconnected tokens as "No details"
                if (!parent || parent === "__ROOT__" || parent.toLowerCase() === "disc" || parent.toLowerCase() === "disconnected")
                {
                    p.innerHTML = '<div class="text-muted small p-2">No details</div>';
                    return;
                }

                var url = '/Cash/CategoryTree/Details?key=' + encodeURIComponent(parent) + '&embed=1';
                fetch(url, { credentials: 'same-origin' })
                    .then(function (r)
                    {
                        if (!r.ok) { throw new Error('bad status: ' + r.status); }
                        return r.text();
                    })
                    .then(function (html)
                    {
                        p.innerHTML = html;
                        try
                        {
                            if (window.$ && window.$.ui && window.$.ui.fancytree)
                            {
                                var tree = $.ui.fancytree.getTree('#categoryTree');
                                if (tree && parent)
                                {
                                    var node = tree.getNodeByKey(parent);
                                    if (node)
                                    {
                                        try { node.makeVisible(); } catch (e) { /* swallow */ }
                                        try { node.setActive(true); } catch (e) { /* swallow */ }
                                    }
                                }
                            }
                        }
                        catch (e) { /* swallow */ }
                    })
                    .catch(function ()
                    {
                        p.innerHTML = '<div class="text-muted small p-2">No details</div>';
                    });
            }
            catch (ex)
            {
                try { window.location.href = '@Url.Page("/Cash/CategoryTree/Index")'; } catch (_) { /* swallow */ }
            }
        }
    </script>
}