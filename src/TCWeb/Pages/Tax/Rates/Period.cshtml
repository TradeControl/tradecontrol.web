@page
@model TradeControl.Web.Pages.Tax.Rates.PeriodModel

@{
    ViewData["Title"] = "Tax Period";

    var embedded = (Request.Query.TryGetValue("embedded", out var emb) && emb == "1");
    var returnNode = Request.Query.TryGetValue("returnNode", out var rn) ? rn.ToString() : "TaxCompany";

    if (embedded)
    {
        Layout = "/Pages/Shared/_EmbeddedLayout.cshtml";
    }

    var backToRatesUrl = $"/Tax/Rates/Index?{(embedded ? "embedded=1&" : "")}returnNode={Uri.EscapeDataString(returnNode)}"
        + (Model.YearNumber.HasValue ? $"&yearNumber={Model.YearNumber.Value}" : "");
}

@if (!embedded)
{
    <h1 class="h4 mb-2 mt-2">@ViewData["Title"]</h1>
}
else
{
    <div class="fw-semibold mb-2">@ViewData["Title"]</div>
}

<div class="bg-white border rounded p-3">
    <div class="mb-3">
        <div class="text-muted small">Period start</div>
        <div class="fw-semibold">@Model.StartOn.ToString("MMMM yyyy")</div>
    </div>

    <details class="border rounded bg-light mb-3" open>
        <summary class="px-3 py-2 fw-semibold" style="cursor:pointer;">Adjustments</summary>
        <div class="p-3 bg-white border-top">
            <form method="post" asp-page-handler="SaveAdjustments" autocomplete="off">
                <input type="hidden" asp-for="StartOn" />
                <input type="hidden" asp-for="YearNumber" />

                @if (embedded)
                {
                    <input type="hidden" name="embedded" value="1" />
                    <input type="hidden" name="returnNode" value="@returnNode" />
                }

                <div class="row g-2">
                    <div class="col-12 col-md-6 mb-3">
                        <label asp-for="VatAdjustment" class="form-label"></label>
                        <input asp-for="VatAdjustment" class="form-control" />
                        <span asp-validation-for="VatAdjustment" class="text-danger"></span>
                    </div>

                    <div class="col-12 col-md-6 mb-3">
                        <label asp-for="CorporationTaxAdjustment" class="form-label"></label>
                        <input asp-for="CorporationTaxAdjustment" class="form-control" />
                        <span asp-validation-for="CorporationTaxAdjustment" class="text-danger"></span>
                    </div>
                </div>

                <div class="d-flex flex-wrap gap-2">
                    <button type="submit" class="btn btn-primary">Save</button>
                    <a class="btn btn-outline-secondary" href="@backToRatesUrl">Cancel</a>
                </div>

                <div class="form-text text-muted mt-2">
                    Adjustments are applied per tax period window. Setting an adjustment here replaces any existing adjustment in the same due-date window.
                </div>
            </form>
        </div>
    </details>

    <details class="border rounded bg-light" open>
        <summary class="px-3 py-2 fw-semibold" style="cursor:pointer;">Corporation Tax Rate (Monthly)</summary>
        <div class="p-3 bg-white border-top">
            <form method="post" asp-page-handler="SaveRate" autocomplete="off">
                <input type="hidden" asp-for="StartOn" />
                <input type="hidden" asp-for="YearNumber" />

                @if (embedded)
                {
                    <input type="hidden" name="embedded" value="1" />
                    <input type="hidden" name="returnNode" value="@returnNode" />
                }

                <div class="row g-2 align-items-end">
                    <div class="col-12 col-md-6 mb-3">
                        <label asp-for="CorporationTaxRatePercent" class="form-label"></label>
                        <div class="input-group">
                            <input asp-for="CorporationTaxRatePercent" class="form-control" inputmode="decimal" />
                            <span class="input-group-text">%</span>
                        </div>
                        <span asp-validation-for="CorporationTaxRatePercent" class="text-danger"></span>
                    </div>

                    <div class="col-12 col-md-6 mb-3">
                        <div class="d-flex flex-column flex-sm-row flex-wrap gap-2 justify-content-start justify-content-md-end">
                            <button type="submit" class="btn btn-primary">Save</button>

                            <a asp-page="./EditRate"
                               asp-route-yearNumber="@Model.YearNumber"
                               asp-route-embedded="@(embedded ? "1" : null)"
                               asp-route-returnNode="@returnNode"
                               class="btn btn-outline-secondary">
                                Set by date range
                            </a>

                            <a class="btn btn-outline-secondary" href="@backToRatesUrl">Cancel</a>
                        </div>
                    </div>
                </div>

                <div class="form-text text-muted mt-2">
                    This sets the rate for this month only. Use “Set by date range” to apply changes across multiple months.
                </div>
            </form>
        </div>
    </details>
</div>
