@page
@inject Wangkanai.Detection.Services.IDetectionService Detection
@using Wangkanai.Detection.Models
@model TradeControl.Web.Pages.Tax.TaxCode.IndexModel

@{
    ViewData["Title"] = "Tax Codes";

    var embedded = (Request.Query.TryGetValue("embedded", out var emb) && emb == "1");
    var returnNode = Request.Query.TryGetValue("returnNode", out var rn) ? rn.ToString() : "TaxCode";

    if (embedded)
    {
        Layout = "/Pages/Shared/_EmbeddedLayout.cshtml";
    }

    var backToManagerUrl = $"/Admin/Manager/Index?node={Uri.EscapeDataString(returnNode)}";
}

@if (!embedded)
{
    <h1 class="h4 mb-2 mt-2">@ViewData["Title"]</h1>
}
else
{
    <div class="fw-semibold mb-2">@ViewData["Title"]</div>
}

<div class="bg-white border rounded p-3">
    @if (!embedded && Detection.Device.Type == Device.Mobile)
    {
        <div class="d-flex flex-wrap gap-2 mb-3">
            <a href="@backToManagerUrl" class="btn btn-outline-secondary" style="min-width: 7.5rem;">
                Back
            </a>
        </div>
    }

    <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
        <form method="get" autocomplete="off" class="d-flex flex-wrap align-items-center gap-2">
            @if (embedded)
            {
                <input type="hidden" name="embedded" value="1" />
                <input type="hidden" name="returnNode" value="@returnNode" />
            }

            <div class="d-flex flex-column">
                <label class="form-label small text-muted mb-1" asp-for="TaxType"></label>
                <select asp-for="TaxType"
                        asp-items="Model.TaxTypes"
                        class="form-select"
                        onchange="this.form.submit()">
                    <option value="">All</option>
                </select>
            </div>
        </form>

        <a asp-page="Create"
           asp-route-taxType="@Model.TaxType"
           asp-route-embedded="@(embedded ? "1" : null)"
           asp-route-returnNode="@returnNode"
           class="btn btn-outline-primary">
            New Tax Code
        </a>
    </div>

    @if (Model.App_TaxCodes == null || Model.App_TaxCodes.Count == 0)
    {
        <div class="alert alert-light border mb-0" role="status">
            No tax codes found.
        </div>
    }
    else
    {
        <div class="table-responsive">
            <table class="table table-sm table-striped align-middle mb-0">
                <thead>
                    <tr>
                        <th>@Html.DisplayNameFor(model => model.App_TaxCodes[0].TaxDescription)</th>
                        @if (Detection?.Device?.Type != Device.Mobile)
                        {
                            <th>@Html.DisplayNameFor(model => model.App_TaxCodes[0].TaxCode)</th>
                            <th>@Html.DisplayNameFor(model => model.App_TaxCodes[0].TaxType)</th>
                            <th>@Html.DisplayNameFor(model => model.App_TaxCodes[0].Rounding)</th>
                            <th>@Html.DisplayNameFor(model => model.App_TaxCodes[0].UpdatedBy)</th>
                            <th>@Html.DisplayNameFor(model => model.App_TaxCodes[0].UpdatedOn)</th>
                        }
                        <th>@Html.DisplayNameFor(model => model.App_TaxCodes[0].TaxRate)</th>
                        <th style="width:1%; white-space:nowrap;"></th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model.App_TaxCodes)
                    {
                        <tr>
                            <td class="fw-semibold">@Html.DisplayFor(modelItem => item.TaxDescription)</td>

                            @if (Detection?.Device?.Type != Device.Mobile)
                            {
                                <td class="text-muted">@Html.DisplayFor(modelItem => item.TaxCode)</td>
                                <td>@Html.DisplayFor(modelItem => item.TaxType)</td>
                                <td>@Html.DisplayFor(modelItem => item.Rounding)</td>
                                <td>@Html.DisplayFor(modelItem => item.UpdatedBy)</td>
                                <td>@Html.DisplayFor(modelItem => item.UpdatedOn)</td>
                            }

                            <td>@Html.DisplayFor(modelItem => item.TaxRate)</td>

                            <td>
                                <div class="btn-group btn-group-sm" role="group">
                                    <a class="btn btn-outline-secondary"
                                       asp-page="./Edit"
                                       asp-route-taxCode="@item.TaxCode"
                                       asp-route-taxType="@Model.TaxType"
                                       asp-route-embedded="@(embedded ? "1" : null)"
                                       asp-route-returnNode="@returnNode"
                                       title="Edit tax code">
                                        <i class="bi bi-pencil" aria-hidden="true"></i>
                                    </a>
                                    <a class="btn btn-outline-danger"
                                       asp-page="./Delete"
                                       asp-route-taxCode="@item.TaxCode"
                                       asp-route-taxType="@Model.TaxType"
                                       asp-route-embedded="@(embedded ? "1" : null)"
                                       asp-route-returnNode="@returnNode"
                                       title="Delete tax code">
                                        <i class="bi bi-trash" aria-hidden="true"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>
