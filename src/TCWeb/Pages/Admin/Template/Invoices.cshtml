@page
@model TradeControl.Web.Pages.Admin.Template.InvoicesModel

@{
    ViewData["Title"] = "Invoice Templates";

    var embedded = false;
    if (Request?.Query.ContainsKey("embedded") == true)
    {
        embedded = string.Equals(Request.Query["embedded"], "1", StringComparison.OrdinalIgnoreCase)
            || string.Equals(Request.Query["embedded"], "true", StringComparison.OrdinalIgnoreCase);
    }

    if (embedded)
    {
        Layout = "/Pages/Shared/_EmbeddedLayout.cshtml";
    }

    var returnNode = (Request?.Query.ContainsKey("returnNode") == true)
        ? (Request.Query["returnNode"].ToString() ?? "Templates")
        : "Templates";

    var templateKey = $"invoiceType:{(short)Model.InvoiceTypeCode}";
    var backHref = $"/Admin/Manager/Index?node=TemplateInvoices&templateKey={Uri.EscapeDataString(templateKey)}";
}

<div class="container-fluid py-2" id="tcInvoiceTemplatesRoot">
    @if (!embedded)
    {
        <h1 class="h4 mb-2">@ViewData["Title"]</h1>
        <div class="text-muted mb-3">Assign HTML templates and attachments to each invoice type.</div>
    }
    else
    {
        <div class="d-flex align-items-start justify-content-between mb-2">
            <div>
                <div class="fw-semibold">@ViewData["Title"]</div>
                <div class="text-muted small">Assign templates and attachments per invoice type</div>
            </div>
            <div class="text-muted small">@Model.InvoiceType</div>
        </div>
    }

    <div class="card shadow-sm mb-3">
        <div class="card-header bg-white d-flex align-items-center justify-content-between flex-wrap gap-2">
            <div class="fw-semibold">Invoice type</div>

            <div class="d-flex align-items-center gap-2 ms-auto flex-wrap">
                @if (!embedded)
                {
                    <a class="btn btn-outline-secondary btn-sm" href="@backHref">Back</a>
                }
            </div>
        </div>

        <div class="card-body">
            <form method="get" class="row g-2 align-items-end">
                <div class="col-12 col-lg-6">
                    <label class="form-label mb-1">Invoice type</label>
                    <select asp-for="InvoiceType"
                            asp-items="Model.InvoiceTypes"
                            class="form-select"
                            onchange="this.form.submit()"></select>
                </div>

                @* preserve context *@
                <input type="hidden" name="embedded" value="@(embedded ? "1" : "0")" />
                <input type="hidden" name="returnNode" value="@returnNode" />
            </form>

            <div class="mt-3 d-flex gap-2 flex-wrap">
                <a asp-page="./Attachments"
                   asp-route-invoiceType="@Model.InvoiceType"
                   asp-route-embedded="@(embedded ? "1" : null)"
                   asp-route-returnNode="@returnNode"
                   class="btn btn-outline-info">
                    Manage attachments
                </a>
            </div>
        </div>
    </div>

    <div class="card shadow-sm mb-3">
        <div class="card-header bg-white d-flex align-items-center justify-content-between flex-wrap gap-2">
            <div class="fw-semibold">Assigned templates</div>

            <div class="d-flex align-items-center gap-2 ms-auto flex-wrap">
                <button type="button" class="btn btn-outline-primary btn-sm" id="tcParseAllBtn">
                    Parse all
                </button>
            </div>
        </div>

        <div class="card-body p-0">
            @if (Model.Web_TemplateInvoices == null || Model.Web_TemplateInvoices.Count == 0)
            {
                <div class="p-3 text-muted">
                    No templates are assigned to <strong>@Model.InvoiceType</strong>.
                </div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-striped mb-0">
                        <thead>
                            <tr>
                                <th>Template</th>
                                <th>Last used</th>
                                <th class="text-end" style="width:1%;white-space:nowrap;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model.Web_TemplateInvoices)
                            {
                                <tr data-template-id="@item.TemplateId" data-template-file="@item.TemplateFileName">
                                    <td class="text-break">
                                        <a asp-page="./Images"
                                           asp-route-templateId="@item.TemplateId"
                                           asp-route-embedded="@(embedded ? "1" : null)"
                                           asp-route-returnNode="@returnNode">
                                            @item.TemplateFileName
                                        </a>
                                    </td>
                                    <td>@item.LastUsedOn</td>
                                    <td class="text-end">
                                        <div class="action-buttons justify-content-end">
                                            <button type="button"
                                                    class="btn btn-outline-primary btn-sm tc-parse-template"
                                                    data-template-id="@item.TemplateId"
                                                    data-template-file="@item.TemplateFileName">
                                                Parse
                                            </button>

                                            <a asp-page="./TemplateRemove"
                                               asp-route-invoiceType="@Model.InvoiceType"
                                               asp-route-templateId="@item.TemplateId"
                                               asp-route-embedded="@(embedded ? "1" : null)"
                                               asp-route-returnNode="@returnNode"
                                               class="btn btn-outline-danger btn-sm">
                                                Remove
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                <div class="border-top p-3 d-none" id="tcParsePanel">
                    <div class="d-flex align-items-start justify-content-between gap-2 flex-wrap">
                        <div>
                            <div class="fw-semibold" id="tcParseTitle">Template parse</div>
                            <div class="text-muted small" id="tcParseSubtitle"></div>
                        </div>
                        <div class="ms-auto">
                            <button type="button" class="btn btn-outline-secondary btn-sm" id="tcParseCloseBtn">Close</button>
                        </div>
                    </div>

                    <div class="mt-3" id="tcParseBusy" style="display:none;">
                        <div class="text-muted">Parsing templateâ€¦</div>
                    </div>

                    <div class="mt-3 alert alert-danger d-none" id="tcParseError"></div>

                    <div class="mt-3 d-none" id="tcParseReport">
                        <div class="row g-3">
                            <div class="col-12 col-lg-6">
                                <div class="card shadow-sm">
                                    <div class="card-header bg-white fw-semibold">Errors</div>
                                    <div class="card-body">
                                        <div class="d-none" id="tcParseNoErrors">
                                            <div class="text-muted">No errors detected.</div>
                                        </div>

                                        <div class="d-none" id="tcParseErrors"></div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-12 col-lg-6">
                                <div class="card shadow-sm">
                                    <div class="card-header bg-white fw-semibold">Info / warnings</div>
                                    <div class="card-body">
                                        <div class="d-none" id="tcParseNoWarnings">
                                            <div class="text-muted">No warnings detected.</div>
                                        </div>

                                        <div class="d-none" id="tcParseWarnings"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mt-3 text-muted small">
                            Parsing updates the template status used by the Admin Manager tree.
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-header bg-white">
            <div class="fw-semibold">Assign a new template</div>
        </div>
        <div class="card-body">
            @if (Model.TemplateFileNames == null || !Model.TemplateFileNames.Any())
            {
                <div class="text-muted">
                    No available templates to assign.
                </div>
            }
            else
            {
                <form method="post" class="row g-2 align-items-end">
                    <div asp-validation-summary="ModelOnly" class="text-danger"></div>

                    <div class="col-12 col-lg-6">
                        <label asp-for="TemplateFileName" class="form-label"></label>
                        <select asp-for="TemplateFileName" asp-items="Model.TemplateFileNames" class="form-select"></select>
                    </div>

                    <div class="col-12 col-lg-auto">
                        <button type="submit" class="btn btn-primary">Assign</button>
                    </div>

                    @* preserve context *@
                    <input type="hidden" name="embedded" value="@(embedded ? "1" : "0")" />
                    <input type="hidden" name="returnNode" value="@returnNode" />
                </form>
            }
        </div>
    </div>
</div>

@if (embedded)
{
    <script>
        (function ()
        {
            try
            {
                window.parent.postMessage(
                    {
                        type: "tc.template.refresh",
                        scope: "invoiceType.templates",
                        invoiceTypeCode: @((short)Model.InvoiceTypeCode)
                    },
                    "*"
                );
            }
            catch
            {
            }
        })();
    </script>
}

<script>
    (function ()
    {
        const parseEndpoint = "/Admin/Template/Parse?handler=Invoice";
        const root = document.getElementById("tcInvoiceTemplatesRoot");
        if (!root)
        {
            return;
        }

        const parsePanel = document.getElementById("tcParsePanel");
        const parseTitle = document.getElementById("tcParseTitle");
        const parseSubtitle = document.getElementById("tcParseSubtitle");
        const parseCloseBtn = document.getElementById("tcParseCloseBtn");

        const parseBusy = document.getElementById("tcParseBusy");
        const parseError = document.getElementById("tcParseError");
        const parseReport = document.getElementById("tcParseReport");

        const noErrors = document.getElementById("tcParseNoErrors");
        const errorsHost = document.getElementById("tcParseErrors");

        const noWarnings = document.getElementById("tcParseNoWarnings");
        const warningsHost = document.getElementById("tcParseWarnings");

        const parseAllBtn = document.getElementById("tcParseAllBtn");

        function showPanel()
        {
            if (!parsePanel)
            {
                return;
            }

            parsePanel.classList.remove("d-none");
        }

        function closePanel()
        {
            if (!parsePanel)
            {
                return;
            }

            parsePanel.classList.add("d-none");
        }

        function setBusy(isBusy)
        {
            if (parseBusy)
            {
                parseBusy.style.display = isBusy ? "" : "none";
            }
        }

        function clearOutput()
        {
            if (parseError)
            {
                parseError.classList.add("d-none");
                parseError.textContent = "";
            }

            if (parseReport)
            {
                parseReport.classList.add("d-none");
            }

            if (errorsHost)
            {
                errorsHost.classList.add("d-none");
                errorsHost.innerHTML = "";
            }

            if (warningsHost)
            {
                warningsHost.classList.add("d-none");
                warningsHost.innerHTML = "";
            }

            if (noErrors)
            {
                noErrors.classList.add("d-none");
            }

            if (noWarnings)
            {
                noWarnings.classList.add("d-none");
            }
        }

        function showError(message)
        {
            if (!parseError)
            {
                return;
            }

            parseError.textContent = message || "Parse failed.";
            parseError.classList.remove("d-none");
        }

        function createList(title, items)
        {
            if (!items || !Array.isArray(items) || items.length === 0)
            {
                return null;
            }

            const wrapper = document.createElement("div");
            wrapper.className = "mb-3";

            const header = document.createElement("div");
            header.className = "fw-semibold mb-1";
            header.textContent = title;
            wrapper.appendChild(header);

            const ul = document.createElement("ul");
            ul.className = "mb-0";

            for (const item of items)
            {
                const li = document.createElement("li");
                li.textContent = item;
                ul.appendChild(li);
            }

            wrapper.appendChild(ul);
            return wrapper;
        }

        function renderReport(report)
        {
            if (!report)
            {
                showError("Empty parse report.");
                return;
            }

            const errorBlocks = [];
            errorBlocks.push(createList("Invalid field tags", report.invalidFieldTags));
            errorBlocks.push(createList("Missing embed directives", report.missingEmbedDirectives));
            errorBlocks.push(createList("Missing embed templates", report.missingEmbedTemplates));
            errorBlocks.push(createList("Invalid embed templates", report.invalidEmbedTemplates));
            errorBlocks.push(createList("Missing required output tags", report.missingRequiredOutputTags));
            errorBlocks.push(createList("Image tags without assignment", report.imageTagsWithoutAssignment));
            errorBlocks.push(createList("Assigned images missing files", report.assignedImagesMissingFiles));

            const warningBlocks = [];
            warningBlocks.push(createList("Assigned image tags without usage", report.assignedImageTagsWithoutUsage));
            warningBlocks.push(createList("Unused available fields", report.unusedAvailableFields));

            if (errorsHost)
            {
                errorsHost.innerHTML = "";
                let any = false;

                for (const block of errorBlocks)
                {
                    if (!block)
                    {
                        continue;
                    }

                    any = true;
                    errorsHost.appendChild(block);
                }

                if (any)
                {
                    errorsHost.classList.remove("d-none");
                    if (noErrors) noErrors.classList.add("d-none");
                }
                else
                {
                    errorsHost.classList.add("d-none");
                    if (noErrors) noErrors.classList.remove("d-none");
                }
            }

            if (warningsHost)
            {
                warningsHost.innerHTML = "";
                let any = false;

                for (const block of warningBlocks)
                {
                    if (!block)
                    {
                        continue;
                    }

                    any = true;
                    warningsHost.appendChild(block);
                }

                if (any)
                {
                    warningsHost.classList.remove("d-none");
                    if (noWarnings) noWarnings.classList.add("d-none");
                }
                else
                {
                    warningsHost.classList.add("d-none");
                    if (noWarnings) noWarnings.classList.remove("d-none");
                }
            }

            if (parseReport)
            {
                parseReport.classList.remove("d-none");
            }
        }

        async function parseTemplate(templateId, templateFileName)
        {
            if (!templateId || templateId <= 0)
            {
                return;
            }

            showPanel();
            clearOutput();
            setBusy(true);

            if (parseTitle)
            {
                parseTitle.textContent = "Template parse";
            }

            if (parseSubtitle)
            {
                parseSubtitle.textContent = templateFileName ? templateFileName : `TemplateId: ${templateId}`;
            }

            try
            {
                const token = document.querySelector("input[name='__RequestVerificationToken']");
                const headers = {};

                if (token && token.value)
                {
                    headers["RequestVerificationToken"] = token.value;
                }

                const url = `${parseEndpoint}&templateId=${encodeURIComponent(templateId)}`;
                const res = await fetch(url,
                {
                    method: "POST",
                    headers: headers
                });

                if (!res.ok)
                {
                    const message = await res.text();
                    showError(message || `HTTP ${res.status}`);
                    return;
                }

                const report = await res.json();
                renderReport(report);

                try
                {
                    window.parent.postMessage(
                        {
                            type: "tc.template.refresh",
                            scope: "invoiceType.templates",
                            invoiceTypeCode: @((short)Model.InvoiceTypeCode)
                        },
                        "*"
                    );
                }
                catch
                {
                }
            }
            catch (e)
            {
                showError(e && e.message ? e.message : "Parse failed.");
            }
            finally
            {
                setBusy(false);
            }
        }

        async function parseAllTemplates()
        {
            const buttons = root.querySelectorAll(".tc-parse-template[data-template-id]");
            if (!buttons || buttons.length === 0)
            {
                return;
            }

            showPanel();
            clearOutput();
            setBusy(true);

            if (parseTitle)
            {
                parseTitle.textContent = "Parsing all templates";
            }

            if (parseSubtitle)
            {
                parseSubtitle.textContent = "Running sequential parse for assigned templates.";
            }

            try
            {
                for (const btn of buttons)
                {
                    const id = Number(btn.getAttribute("data-template-id"));
                    const name = btn.getAttribute("data-template-file") || "";

                    await parseTemplate(id, name);
                }
            }
            finally
            {
                setBusy(false);
            }
        }

        root.addEventListener("click", function (e)
        {
            const t = e && e.target ? e.target : null;
            if (!t)
            {
                return;
            }

            const parseBtn = t.closest ? t.closest(".tc-parse-template") : null;
            if (!parseBtn)
            {
                return;
            }

            e.preventDefault();

            const templateId = Number(parseBtn.getAttribute("data-template-id"));
            const templateFile = parseBtn.getAttribute("data-template-file") || "";

            parseTemplate(templateId, templateFile);
        });

        if (parseCloseBtn)
        {
            parseCloseBtn.addEventListener("click", function ()
            {
                closePanel();
            });
        }

        if (parseAllBtn)
        {
            parseAllBtn.addEventListener("click", function ()
            {
                parseAllTemplates();
            });
        }
    })();
</script>
