@using Microsoft.AspNetCore.Components
@using Microsoft.JSInterop
@using TradeControl.Web.AppServices
@inject Wangkanai.Detection.Services.IDetectionService Detection
@inject IInvoiceTypeLookup InvoiceTypeLookup

<div class="tc-tree-manager">
    <div class="tc-tree-manager-frame border rounded bg-white p-2">
        @if (_isMobile)
        {
            <div class="d-flex flex-column" style="min-height:0; height:100%;">
                <div class="flex-grow-1 border rounded bg-white p-2" style="min-height:0;">
                    @* Mobile *@
                    <ManagerTreeHost @ref="_treeHost"
                                     RootLabel="@_companyName"
                                     IsMobile="true"
                                     InitialSelectedNode="@_selected"
                                     InitialContentType="@_selectedContentType"
                                     InitialTemplateKey="@_initialTemplateKey"
                                     OnNodeSelected="HandleNodeSelectedAsync"
                                     OnNodeSelectedEx="HandleNodeSelectedExAsync"
                                     OnTreeAction="HandleTreeActionAsync"
                                     OnTemplateSelection="HandleTemplateSelectionAsync" />
                </div>
            </div>
        }
        else
        {
            <div class="tc-tree-split">
                <div id="leftCol" class="tc-pane tc-initial-left">
                    <div class="flex-grow-1 border rounded p-2 bg-white" style="min-height:220px;">
                        @* Desktop *@
                        <ManagerTreeHost @ref="_treeHost"
                                         RootLabel="@_companyName"
                                         IsMobile="false"
                                         InitialSelectedNode="@_selected"
                                         InitialContentType="@_selectedContentType"
                                         InitialTemplateKey="@_initialTemplateKey"
                                         OnNodeSelected="HandleNodeSelectedAsync"
                                         OnNodeSelectedEx="HandleNodeSelectedExAsync"
                                         OnTreeAction="HandleTreeActionAsync"
                                         OnTemplateSelection="HandleTemplateSelectionAsync" />
                    </div>
                </div>

                <div id="rightCol" class="tc-pane tc-initial-right d-none d-lg-flex">
                    <div class="flex-grow-1 border rounded p-2 bg-light d-flex flex-column">
                        <div class="d-flex align-items-center justify-content-between mb-2">
                            <div class="fw-semibold">
                                <i class="bi bi-building me-2" aria-hidden="true"></i>@RightHeader
                            </div>
                        </div>

                        @if (_selected == ManagerTreeHost.ManagerNode.Root)
                        {
                            <div class="bg-white border rounded p-3">
                                <h2 class="h6 mb-2">Configuration</h2>
                                <p class="text-muted mb-3">Select a section to configure the business.</p>

                                <div class="d-grid gap-2">
                                    <button type="button"
                                            class="btn btn-outline-primary text-start"
                                            @onclick="() => HandleNodeSelectedAsync(ManagerTreeHost.ManagerNode.Setup)">
                                        <i class="bi bi-gear me-2" aria-hidden="true"></i>Setup
                                    </button>

                                    <button type="button"
                                            class="btn btn-outline-primary text-start"
                                            @onclick="() => HandleNodeSelectedAsync(ManagerTreeHost.ManagerNode.FileTransfer)">
                                        <i class="bi bi-upload me-2" aria-hidden="true"></i>File Transfer
                                    </button>

                                    <button type="button"
                                            class="btn btn-outline-primary text-start"
                                            @onclick="() => HandleNodeSelectedAsync(ManagerTreeHost.ManagerNode.Users)">
                                        <i class="bi bi-people me-2" aria-hidden="true"></i>Users
                                    </button>

                                    <button type="button"
                                            class="btn btn-outline-primary text-start"
                                            @onclick="() => HandleNodeSelectedAsync(ManagerTreeHost.ManagerNode.Templates)">
                                        <i class="bi bi-filetype-html me-2" aria-hidden="true"></i>Templates
                                    </button>

                                    <button type="button"
                                            class="btn btn-outline-primary text-start"
                                            @onclick="() => HandleNodeSelectedAsync(ManagerTreeHost.ManagerNode.Host)">
                                        <i class="bi bi-envelope-at me-2" aria-hidden="true"></i>Mail Host
                                    </button>

                                    <button type="button"
                                            class="btn btn-outline-primary text-start"
                                            @onclick="() => HandleNodeSelectedAsync(ManagerTreeHost.ManagerNode.Periods)">
                                        <i class="bi bi-calendar3 me-2" aria-hidden="true"></i>Financial Periods
                                    </button>
                                </div>

                                <hr class="my-3" />

                                <div class="d-grid gap-2 mt-2">

                                    <button type="button" class="btn btn-outline-secondary text-start" disabled>
                                        <i class="bi bi-hash me-2" aria-hidden="true"></i>Invoice Settings
                                    </button>

                                    <button type="button" class="btn btn-outline-secondary text-start" disabled>
                                        <i class="bi bi-sliders me-2" aria-hidden="true"></i>Tax Settings
                                    </button>

                                    <button type="button" class="btn btn-outline-secondary text-start" disabled>
                                        <i class="bi bi-receipt me-2" aria-hidden="true"></i>VAT Codes
                                    </button>

                                    <button type="button" class="btn btn-outline-secondary text-start" disabled>
                                        <i class="bi bi-bank me-2" aria-hidden="true"></i>Corporation Tax
                                    </button>

                                    <button type="button" class="btn btn-outline-secondary text-start" disabled>
                                        <i class="bi bi-tags me-2" aria-hidden="true"></i>Subject Types
                                    </button>
                                </div>
                            </div>
                        }
                        else if (_selected == ManagerTreeHost.ManagerNode.Templates)
                        {
                            <div class="bg-white border rounded p-3">
                                <h2 class="h6 mb-2">Templates</h2>
                                <p class="text-muted mb-3">
                                    Templates are HTML documents that include tags like <code>[CompanyName]</code> and <code>[InvoiceDetails]</code>.
                                    When an email is sent, Trade Control replaces tags with data from the relevant document and embeds any referenced images.
                                </p>

                                <div class="d-grid gap-2">
                                    <button type="button"
                                            class="btn btn-outline-primary text-start"
                                            @onclick="() => HandleNodeSelectedAsync(ManagerTreeHost.ManagerNode.TemplateInvoices)">
                                        <i class="bi bi-receipt me-2" aria-hidden="true"></i>Invoices
                                    </button>

                                    <button type="button"
                                            class="btn btn-outline-primary text-start"
                                            @onclick="() => HandleNodeSelectedAsync(ManagerTreeHost.ManagerNode.TemplateSystem)">
                                        <i class="bi bi-gear me-2" aria-hidden="true"></i>System
                                    </button>
                                </div>
                            </div>
                        }
                        else
                        {
                            @RenderRightPane()
                        }
                    </div>
                </div>
            </div>
        }
    </div>
</div>

@code {
    [Parameter] public string CompanyName { get; set; } = "Business";

    private bool _isMobile;
    private string _companyName = "Business";
    private ManagerTreeHost.ManagerNode _selected = ManagerTreeHost.ManagerNode.Root;
    private string? _selectedContentType;
    private string? _iframeSrc;
    private string? _initialTemplateKey;

    private int _fileTransferPageSize = 25;

    private string RightHeader => _selected switch
    {
        ManagerTreeHost.ManagerNode.Root => _companyName,
        ManagerTreeHost.ManagerNode.Setup => $"{_companyName} / Setup",
        ManagerTreeHost.ManagerNode.FileTransfer => $"{_companyName} / File Transfer",
        ManagerTreeHost.ManagerNode.FileTransferContentType => $"{_companyName} / File Transfer / {_selectedContentType}",
        ManagerTreeHost.ManagerNode.Host => $"{_companyName} / Mail Host",
        ManagerTreeHost.ManagerNode.Users => $"{_companyName} / Users",
        ManagerTreeHost.ManagerNode.Templates => $"{_companyName} / Templates",
        ManagerTreeHost.ManagerNode.TemplateInvoices => $"{_companyName} / Templates / Invoices",
        ManagerTreeHost.ManagerNode.TemplateSystem => $"{_companyName} / Templates / System",
        ManagerTreeHost.ManagerNode.Periods => $"{_companyName} / Financial Periods",
        _ => _companyName
    };

    private RenderFragment RenderRightPane() => _selected switch
    {
        _ when !string.IsNullOrWhiteSpace(_iframeSrc) =>
            @<iframe class="w-100 border rounded bg-white tc-details-frame"
                     title="Details"
                     src="@_iframeSrc"></iframe>,

        _ => @<div class="bg-white border rounded p-3">
    <div class="text-muted">Not implemented in Admin Manager yet.</div>
</div>
    };

    [Inject] private NavigationManager NavigationManager { get; set; } = default!;
    [Inject] private IJSRuntime JSRuntime { get; set; } = default!;

    private ManagerTreeHost? _treeHost;
    private DotNetObjectReference<ManagerShell>? _dotNetRef;

    protected override void OnParametersSet()
    {
        _companyName = CompanyName;
        _isMobile = Detection?.Device?.Type == Wangkanai.Detection.Models.Device.Mobile;

        var uri = NavigationManager.ToAbsoluteUri(NavigationManager.Uri);
        var qs = Microsoft.AspNetCore.WebUtilities.QueryHelpers.ParseQuery(uri.Query);

        if (qs.TryGetValue("node", out var nodeValue))
        {
            if (Enum.TryParse<ManagerTreeHost.ManagerNode>(nodeValue.ToString(), ignoreCase: true, out var node))
                _selected = node;
        }

        if (qs.TryGetValue("pageSize", out var pageSizeValue))
        {
            if (int.TryParse(pageSizeValue.ToString(), out var ps) && ps > 0)
                _fileTransferPageSize = ps;
        }

        if (qs.TryGetValue("contentType", out var ct))
            _selectedContentType = ct.ToString();

        if (qs.TryGetValue("templateKey", out var tk))
            _initialTemplateKey = tk.ToString();

        if (!_isMobile)
        {
            _iframeSrc = _selected switch
            {
                ManagerTreeHost.ManagerNode.Setup => "/Admin/Setup/Index?embedded=1",

                ManagerTreeHost.ManagerNode.FileTransfer =>
                    $"/Admin/FileTransfer/Index?embedded=1&returnNode=FileTransfer&pageSize={_fileTransferPageSize}",

                ManagerTreeHost.ManagerNode.FileTransferContentType when !string.IsNullOrWhiteSpace(_selectedContentType) =>
                    $"/Admin/FileTransfer/Index?embedded=1&returnNode=FileTransfer&contentType={Uri.EscapeDataString(_selectedContentType)}&pageSize={_fileTransferPageSize}",

                ManagerTreeHost.ManagerNode.Host =>
                    "/Admin/Host/Index?embedded=1&returnNode=Host",

                ManagerTreeHost.ManagerNode.Users =>
                    "/Admin/Users/Index?embedded=1&returnNode=Users",

                ManagerTreeHost.ManagerNode.TemplateInvoices =>
                    "/Admin/Template/Invoices?embedded=1&returnNode=Templates",

                ManagerTreeHost.ManagerNode.TemplateSystem =>
                    "/Admin/Template/System?embedded=1&returnNode=Templates",

                ManagerTreeHost.ManagerNode.Periods =>
                    "/Admin/Periods/Index?embedded=1&returnNode=Periods",

                _ => null
            };
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_isMobile)
        {
            _dotNetRef = DotNetObjectReference.Create(this);
            await JSRuntime.InvokeVoidAsync("adminManager.registerTemplateRefreshListener", _dotNetRef);

            await JSRuntime.InvokeVoidAsync("adminManager.initSplit");
            await RefreshFileTransferPageSizeAsync();

            if (_selected == ManagerTreeHost.ManagerNode.FileTransfer)
                _iframeSrc = $"/Admin/FileTransfer/Index?embedded=1&returnNode=FileTransfer&pageSize={_fileTransferPageSize}";
            else if (_selected == ManagerTreeHost.ManagerNode.FileTransferContentType && !string.IsNullOrWhiteSpace(_selectedContentType))
                _iframeSrc = $"/Admin/FileTransfer/Index?embedded=1&returnNode=FileTransfer&contentType={Uri.EscapeDataString(_selectedContentType)}&pageSize={_fileTransferPageSize}";

            StateHasChanged();
        }
    }

    public async ValueTask DisposeAsync()
    {
        try
        {
            if (!_isMobile)
                await JSRuntime.InvokeVoidAsync("adminManager.unregisterTemplateRefreshListener");
        }
        catch
        {
        }

        _dotNetRef?.Dispose();
    }

    [JSInvokable]
    public void RefreshInvoiceTypeTemplates(short invoiceTypeCode) => _treeHost?.RequestRefreshTemplatesForInvoiceType(invoiceTypeCode);

    [JSInvokable]
    public void RefreshInvoiceTypeAttachments(short invoiceTypeCode) => _treeHost?.RequestRefreshTemplatesForInvoiceType(invoiceTypeCode);

    [JSInvokable]
    public void RefreshTemplateImages(int templateId) => _treeHost?.RequestRefreshTemplatesForInvoiceType(0);

    private async Task RefreshFileTransferPageSizeAsync()
    {
        try
        {
            _fileTransferPageSize = await JSRuntime.InvokeAsync<int>("adminManager.getFileTransferPageSize");
        }
        catch
        {
            _fileTransferPageSize = 25;
        }
    }

    private Task HandleNodeSelectedAsync(ManagerTreeHost.ManagerNode node)
    {
        _selected = node;

        if (_isMobile)
        {
            if (node == ManagerTreeHost.ManagerNode.Setup)
                NavigationManager.NavigateTo($"/Admin/Setup/Index?returnNode={node}", forceLoad: true);

            if (node == ManagerTreeHost.ManagerNode.FileTransfer)
                NavigationManager.NavigateTo($"/Admin/FileTransfer/Index?returnNode=FileTransfer&pageSize={_fileTransferPageSize}", forceLoad: true);

            if (node == ManagerTreeHost.ManagerNode.Host)
                NavigationManager.NavigateTo("/Admin/Host/Index?returnNode=Host", forceLoad: true);

            if (node == ManagerTreeHost.ManagerNode.Users)
                NavigationManager.NavigateTo("/Admin/Users/Index?returnNode=Users", forceLoad: true);

            if (node == ManagerTreeHost.ManagerNode.Templates)
                NavigationManager.NavigateTo("/Admin/Manager/Index?node=Templates", forceLoad: true);

            if (node == ManagerTreeHost.ManagerNode.TemplateInvoices)
                NavigationManager.NavigateTo("/Admin/Template/Invoices?returnNode=Templates", forceLoad: true);

            if (node == ManagerTreeHost.ManagerNode.TemplateSystem)
                NavigationManager.NavigateTo("/Admin/Template/System?returnNode=Templates", forceLoad: true);

            if (node == ManagerTreeHost.ManagerNode.Periods)
                NavigationManager.NavigateTo("/Admin/Periods/Index?returnNode=Periods", forceLoad: true);

            return Task.CompletedTask;
        }

        if (node == ManagerTreeHost.ManagerNode.Root)
        {
            _iframeSrc = null;
            return Task.CompletedTask;
        }

        _iframeSrc = node switch
        {
            ManagerTreeHost.ManagerNode.Setup => "/Admin/Setup/Index?embedded=1",
            ManagerTreeHost.ManagerNode.FileTransfer => $"/Admin/FileTransfer/Index?embedded=1&returnNode=FileTransfer&pageSize={_fileTransferPageSize}",
            ManagerTreeHost.ManagerNode.Host => "/Admin/Host/Index?embedded=1&returnNode=Host",
            ManagerTreeHost.ManagerNode.Users => "/Admin/Users/Index?embedded=1&returnNode=Users",
            ManagerTreeHost.ManagerNode.TemplateInvoices => "/Admin/Template/Invoices?embedded=1&returnNode=Templates",
            ManagerTreeHost.ManagerNode.TemplateSystem => "/Admin/Template/System?embedded=1&returnNode=Templates",
            ManagerTreeHost.ManagerNode.Periods => "/Admin/Periods/Index?embedded=1&returnNode=Periods",
            _ => null
        };

        return Task.CompletedTask;
    }

    private async Task HandleNodeSelectedExAsync((ManagerTreeHost.ManagerNode Node, string? ContentType) selection)
    {
        _selected = selection.Node;
        _selectedContentType = selection.ContentType;

        await RefreshFileTransferPageSizeAsync();

        if (_selected == ManagerTreeHost.ManagerNode.FileTransferContentType && !string.IsNullOrWhiteSpace(_selectedContentType))
        {
            var contentType = Uri.EscapeDataString(_selectedContentType);

            if (_isMobile)
            {
                NavigationManager.NavigateTo($"/Admin/FileTransfer/Index?returnNode=FileTransfer&contentType={contentType}&pageSize={_fileTransferPageSize}", forceLoad: true);
                return;
            }

            _iframeSrc = $"/Admin/FileTransfer/Index?embedded=1&returnNode=FileTransfer&contentType={contentType}&pageSize={_fileTransferPageSize}";
        }
    }

    private async Task HandleTreeActionAsync(ManagerTreeHost.TreeAction action)
    {
        await RefreshFileTransferPageSizeAsync();

        if (action.ActionType == ManagerTreeHost.TreeActionType.FileTransferSync)
        {
            var contentType = !string.IsNullOrWhiteSpace(_selectedContentType)
                ? Uri.EscapeDataString(_selectedContentType)
                : "All";

            if (_isMobile)
            {
                NavigationManager.NavigateTo($"/Admin/FileTransfer/Index?handler=SyncFiles&returnNode=FileTransfer&contentType={contentType}&pageNumber=1&pageSize={_fileTransferPageSize}", forceLoad: true);
                return;
            }

            _iframeSrc = $"/Admin/FileTransfer/Index?handler=SyncFiles&embedded=1&returnNode=FileTransfer&contentType={contentType}&pageNumber=1&pageSize={_fileTransferPageSize}";
            return;
        }

        if (action.ActionType == ManagerTreeHost.TreeActionType.FileTransferUpload && !string.IsNullOrWhiteSpace(action.ContentType))
        {
            if (_isMobile)
            {
                NavigationManager.NavigateTo($"/Admin/FileTransfer/Upload?returnNode=FileTransfer&contentType={Uri.EscapeDataString(action.ContentType)}", forceLoad: true);
                return;
            }

            _selected = ManagerTreeHost.ManagerNode.FileTransferContentType;
            _selectedContentType = action.ContentType;
            _iframeSrc = $"/Admin/FileTransfer/Upload?embedded=1&returnNode=FileTransfer&contentType={Uri.EscapeDataString(action.ContentType)}";
        }
    }

    private async Task HandleTemplateSelectionAsync(ManagerTreeHost.TemplateSelection selection)
    {
        _selected = ManagerTreeHost.ManagerNode.TemplateInvoices;

        var url = await GetTemplateUrlAsync(selection, embedded: !_isMobile);

        if (_isMobile)
        {
            NavigationManager.NavigateTo(url, forceLoad: true);
            return;
        }

        _iframeSrc = url;
    }

    private async Task<string> GetTemplateUrlAsync(ManagerTreeHost.TemplateSelection selection, bool embedded)
    {
        var embeddedQs = embedded ? "embedded=1&" : string.Empty;
        var returnQs = "returnNode=Templates&";

        if (selection.InvoiceTypeCode.HasValue)
        {
            var invoiceType = await InvoiceTypeLookup.GetInvoiceTypeNameAsync(selection.InvoiceTypeCode.Value);

            if (!string.IsNullOrWhiteSpace(invoiceType))
            {
                var invoiceTypeQs = $"invoiceType={Uri.EscapeDataString(invoiceType)}&";

                if (selection.Kind is "AttachmentsFolder" or "Attachment")
                    return $"/Admin/Template/Attachments?{embeddedQs}{returnQs}{invoiceTypeQs}";

                if (selection.Kind is "InvoiceType" or "TemplatesFolder")
                    return $"/Admin/Template/Invoices?{embeddedQs}{returnQs}{invoiceTypeQs}";
            }
        }

        return selection.Kind switch
        {
            "Template" or "ImagesFolder" when selection.TemplateId.HasValue
                => $"/Admin/Template/Images?{embeddedQs}{returnQs}templateId={selection.TemplateId.Value}",

            "Image" when selection.TemplateId.HasValue && !string.IsNullOrWhiteSpace(selection.ImageTag)
                => $"/Admin/Template/ImageEdit?{embeddedQs}{returnQs}templateId={selection.TemplateId.Value}&imageTag={Uri.EscapeDataString(selection.ImageTag)}",

            _ => $"/Admin/Template/Invoices?{embeddedQs}{returnQs}"
        };
    }
}
